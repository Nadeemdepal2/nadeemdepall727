name: RDP Setup + VirtualBox + Extension Pack + OVA Import

on:
  workflow_dispatch:

jobs:
  setup-rdp-and-vm:
    runs-on: windows-latest
    timeout-minutes: 3600

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      # ------------------------------
      # RDP CONFIG
      # ------------------------------
      - name: Configure RDP
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389
          Restart-Service -Name TermService -Force

      # ------------------------------
      # ADMIN ACCOUNT
      # ------------------------------
      - name: Configure Administrator Account
        run: |
          $password = 'Zain.rty123'
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          Set-LocalUser -Name "Administrator" -Password $securePass
          Add-LocalGroupMember -Group "Administrators" -Member "Administrator" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "Administrator" -ErrorAction SilentlyContinue
          echo "RDP_CREDS=$password" >> $env:GITHUB_ENV

      # ------------------------------
      # KEEP SESSION ACTIVE
      # ------------------------------
      - name: Keep Session Alive
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fResetBroken" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "IdleTimeout" -Value 0
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "MaxIdleTime" -Value 0
          powercfg.exe /change monitor-timeout-ac 0
          powercfg.exe /change standby-timeout-ac 0

      # ------------------------------
      # TAILSCALE INSTALL
      # ------------------------------
      - name: Install Tailscale
        run: |
          $url = "https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi"
          $file = "$env:TEMP\ts.msi"
          Invoke-WebRequest -Uri $url -OutFile $file
          Start-Process msiexec.exe -ArgumentList "/i `"$file`" /qn /norestart" -Wait

      - name: Authenticate Tailscale
        run: |
          $authKey = "${{ secrets.TAILSCALE_AUTH_KEY }}"
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$authKey --hostname=gh-runner-$env:GITHUB_RUN_ID
          $ip = ""
          for ($i=0; $i -lt 12; $i++) {
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
            if ($ip) { break }
            Start-Sleep 5
          }
          if (-not $ip) { Write-Error "No Tailscale IP"; exit 1 }
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      # ------------------------------
      # VERIFY RDP
      # ------------------------------
      - name: Verify RDP Port
        run: |
          Write-Host "Tailscale IP: $env:TAILSCALE_IP"
          $result = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389
          if (-not $result.TcpTestSucceeded) { Write-Error "Port 3389 closed"; exit 1 }

      # ------------------------------
      # DOWNLOAD VIRTUALBOX + OVA + EXT PACK
      # ------------------------------
      - name: Download VirtualBox, OVA, Extension Pack
        run: |
          $dest = "C:\Users\Administrator\Desktop\Public"
          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest | Out-Null }

          Invoke-WebRequest -Uri "https://download.virtualbox.org/virtualbox/7.2.4/VirtualBox-7.2.4-170995-Win.exe" -OutFile "$dest\VBox.exe"
          Invoke-WebRequest -Uri "https://download.virtualbox.org/virtualbox/7.2.4/Oracle_VirtualBox_Extension_Pack-7.2.4.vbox-extpack" -OutFile "$dest\ExtensionPack.vbox-extpack"
          Invoke-WebRequest -Uri "https://pub-4e3db5ccea8a4f30ae7d4ee15e71f566.r2.dev/Nadeem.ova" -OutFile "$dest\Nadeem.ova"

      # ------------------------------
      # INSTALL VIRTUALBOX
      # ------------------------------
      - name: Install VirtualBox
        run: |
          & "C:\Users\Administrator\Desktop\Public\VBox.exe" --silent --msiparams REBOOT=0 ALLUSERS=2

      # ------------------------------
      # INSTALL EXTENSION PACK
      # ------------------------------
      - name: Install VirtualBox Extension Pack
        run: |
          $manage = "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe"
          $pack = "C:\Users\Administrator\Desktop\Public\ExtensionPack.vbox-extpack"
          & $manage extpack install "$pack" --replace --accept-license=56be48f923303c8cababb0f13cd7a233

      # ------------------------------
      # IMPORT OVA
      # ------------------------------
      - name: Import OVA into VirtualBox
        run: |
          $manage = "C:\Program Files\Oracle\VirtualBox\VBoxManage.exe"
          & $manage import "C:\Users\Administrator\Desktop\Public\Nadeem.ova" --vsys 0 --eula accept

      # ------------------------------
      # KEEP MACHINE ALIVE
      # ------------------------------
      - name: Keep RDP Alive
        run: |
          Write-Host "======================================="
          Write-Host "RDP IP: $env:TAILSCALE_IP"
          Write-Host "User: Administrator"
          Write-Host "Pass: $env:RDP_CREDS"
          Write-Host "======================================="
          while ($true) {
            Write-Host "[$(Get-Date)] Runner active"
            Start-Sleep -Seconds 300
          }
